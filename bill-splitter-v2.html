<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Splitter</title>
    <link href="https://unpkg.com/tailwindcss@3.4.1/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <div id="root">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(to bottom right, #EFF6FF, #E0E7FF);">
            <div style="text-align: center;">
                <div style="width: 64px; height: 64px; border: 4px solid #4F46E5; border-top-color: transparent; border-radius: 50%; margin: 0 auto 16px; animation: spin 1s linear infinite;"></div>
                <p style="color: #6B7280;" id="loading-status">Loading scripts...</p>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- Load scripts with onload handlers -->
    <script>
        window.scriptsLoaded = {
            react: false,
            reactDOM: false,
            firebase: false
        };

        function updateStatus(msg) {
            const el = document.getElementById('loading-status');
            if (el) el.textContent = msg;
            console.log(msg);
        }

        function checkAllLoaded() {
            if (window.scriptsLoaded.react && window.scriptsLoaded.reactDOM && window.scriptsLoaded.firebase) {
                updateStatus('All scripts loaded! Starting app...');
                setTimeout(startApp, 100);
            }
        }

        function startApp() {
            console.log('=== Starting App ===');
            console.log('React:', typeof React);
            console.log('ReactDOM:', typeof ReactDOM);
            console.log('firebase:', typeof firebase);

            if (typeof React === 'undefined' || typeof ReactDOM === 'undefined' || typeof firebase === 'undefined') {
                updateStatus('ERROR: Scripts failed to load. Check console (F12).');
                console.error('Missing:', {
                    React: typeof React,
                    ReactDOM: typeof ReactDOM,
                    firebase: typeof firebase
                });
                return;
            }

            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyANplgQXh_UMoU29BOsMU1qihpLZaNz8D0",
                authDomain: "billsplitx.firebaseapp.com",
                databaseURL: "https://billsplitx-default-rtdb.firebaseio.com",
                projectId: "billsplitx",
                storageBucket: "billsplitx.firebasestorage.app",
                messagingSenderId: "970250474982",
                appId: "1:970250474982:web:860881a78820a315127227"
            };

            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
            console.log('âœ… Firebase initialized');

            const { useState, useEffect, createElement: e } = React;

            function BillSplitter() {
                const [groupId, setGroupId] = useState('');
                const [groupInput, setGroupInput] = useState('');
                const [showGroupInput, setShowGroupInput] = useState(true);
                const [loading, setLoading] = useState(false);
                const [friends, setFriends] = useState([]);
                const [expenses, setExpenses] = useState([]);
                const [showAddFriend, setShowAddFriend] = useState(false);
                const [showAddExpense, setShowAddExpense] = useState(false);
                const [showSettlement, setShowSettlement] = useState(false);
                const [newFriendName, setNewFriendName] = useState('');
                const [expenseDesc, setExpenseDesc] = useState('');
                const [expenseAmount, setExpenseAmount] = useState('');
                const [expensePayer, setExpensePayer] = useState('');
                const [expenseParticipants, setExpenseParticipants] = useState(new Set());
                const [copied, setCopied] = useState(false);

                useEffect(() => {
                    if (!groupId) return;
                    console.log('Setting up listeners for:', groupId);

                    const friendsRef = database.ref(`groups/${groupId}/friends`);
                    const expensesRef = database.ref(`groups/${groupId}/expenses`);

                    friendsRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        setFriends(data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : []);
                        setLoading(false);
                    });

                    expensesRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        setExpenses(data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : []);
                    });

                    return () => {
                        friendsRef.off();
                        expensesRef.off();
                    };
                }, [groupId]);

                useEffect(() => {
                    const saved = localStorage.getItem('billSplitterGroupId');
                    if (saved) {
                        setGroupInput(saved);
                        setGroupId(saved);
                        setShowGroupInput(false);
                        setLoading(true);
                    }
                }, []);

                const joinGroup = () => {
                    if (groupInput.trim()) {
                        setLoading(true);
                        setGroupId(groupInput.trim());
                        setShowGroupInput(false);
                        localStorage.setItem('billSplitterGroupId', groupInput.trim());
                    }
                };

                const leaveGroup = () => {
                    setGroupId('');
                    setFriends([]);
                    setExpenses([]);
                    setShowGroupInput(true);
                    setGroupInput('');
                    setLoading(false);
                    localStorage.removeItem('billSplitterGroupId');
                };

                const generateId = () => setGroupInput(Math.random().toString(36).substring(2, 8).toUpperCase());

                const addFriend = () => {
                    if (newFriendName.trim()) {
                        database.ref(`groups/${groupId}/friends`).push().set({ 
                            name: newFriendName.trim(), 
                            createdAt: Date.now() 
                        });
                        setNewFriendName('');
                        setShowAddFriend(false);
                    }
                };

                const removeFriend = (id) => {
                    database.ref(`groups/${groupId}/friends/${id}`).remove();
                    expenses.forEach(exp => {
                        if (exp.payerId === id || exp.participantIds.includes(id)) {
                            database.ref(`groups/${groupId}/expenses/${exp.id}`).remove();
                        }
                    });
                };

                const addExpense = () => {
                    if (expenseDesc && expenseAmount && expensePayer && expenseParticipants.size > 0) {
                        database.ref(`groups/${groupId}/expenses`).push().set({
                            description: expenseDesc,
                            amount: parseFloat(expenseAmount),
                            payerId: expensePayer,
                            participantIds: Array.from(expenseParticipants),
                            date: Date.now()
                        });
                        setExpenseDesc('');
                        setExpenseAmount('');
                        setExpensePayer('');
                        setExpenseParticipants(new Set());
                        setShowAddExpense(false);
                    }
                };

                const removeExpense = (id) => database.ref(`groups/${groupId}/expenses/${id}`).remove();

                const toggleParticipant = (id) => {
                    const newSet = new Set(expenseParticipants);
                    newSet.has(id) ? newSet.delete(id) : newSet.add(id);
                    setExpenseParticipants(newSet);
                };

                const copyId = () => {
                    navigator.clipboard.writeText(groupId);
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                };

                const calculateBalances = () => {
                    const balances = {};
                    friends.forEach(f => balances[f.id] = 0);
                    expenses.forEach(exp => {
                        const share = exp.amount / exp.participantIds.length;
                        balances[exp.payerId] = (balances[exp.payerId] || 0) + exp.amount;
                        exp.participantIds.forEach(id => balances[id] = (balances[id] || 0) - share);
                    });
                    return balances;
                };

                const calculateSettlements = () => {
                    const balances = calculateBalances();
                    const settlements = [];
                    let debtors = [], creditors = [];

                    Object.entries(balances).forEach(([id, bal]) => {
                        if (bal < -0.01) debtors.push({ id, amount: -bal });
                        else if (bal > 0.01) creditors.push({ id, amount: bal });
                    });

                    debtors.sort((a, b) => b.amount - a.amount);
                    creditors.sort((a, b) => b.amount - a.amount);

                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        const amt = Math.min(debtors[i].amount, creditors[j].amount);
                        settlements.push({ from: debtors[i].id, to: creditors[j].id, amount: amt });
                        debtors[i].amount -= amt;
                        creditors[j].amount -= amt;
                        if (debtors[i].amount < 0.01) i++;
                        if (creditors[j].amount < 0.01) j++;
                    }
                    return settlements;
                };

                const getFriendName = (id) => friends.find(f => f.id === id)?.name || 'Unknown';
                const balances = calculateBalances();
                const settlements = calculateSettlements();

                if (showGroupInput) {
                    return e('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex items-center justify-center' },
                        e('div', { className: 'bg-white rounded-lg shadow-xl p-8 max-w-md w-full' },
                            e('div', { className: 'text-center mb-6' },
                                e('h1', { className: 'text-3xl font-bold text-indigo-600 mb-2' }, 'ðŸ’° Bill Splitter'),
                                e('p', { className: 'text-gray-600' }, 'Create or join a group')
                            ),
                            e('input', {
                                type: 'text',
                                value: groupInput,
                                onChange: (ev) => setGroupInput(ev.target.value.toUpperCase()),
                                onKeyPress: (ev) => ev.key === 'Enter' && joinGroup(),
                                placeholder: 'Enter Group ID',
                                className: 'w-full px-4 py-3 border rounded-lg mb-3 text-center text-lg font-mono',
                                maxLength: 10
                            }),
                            e('button', {
                                onClick: joinGroup,
                                disabled: !groupInput.trim(),
                                className: 'w-full bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 mb-3 font-semibold'
                            }, 'Join / Create Group'),
                            e('button', {
                                onClick: generateId,
                                className: 'w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold'
                            }, '+ Generate New ID')
                        )
                    );
                }

                if (loading) {
                    return e('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 flex items-center justify-center' },
                        e('div', { className: 'text-center' },
                            e('div', { className: 'animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4' }),
                            e('p', { className: 'text-gray-600' }, 'Loading: ' + groupId),
                            e('button', {
                                onClick: leaveGroup,
                                className: 'mt-4 text-sm text-indigo-600 hover:text-indigo-800'
                            }, 'Cancel')
                        )
                    );
                }

                // Main app UI - simplified for brevity, showing key sections
                return e('div', { className: 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4' },
                    e('div', { className: 'max-w-4xl mx-auto' },
                        e('div', { className: 'bg-white rounded-lg shadow-lg p-6 mb-6' },
                            e('div', { className: 'flex justify-between mb-4' },
                                e('h1', { className: 'text-3xl font-bold text-indigo-600' }, 'ðŸ’° Bill Splitter'),
                                e('button', { onClick: leaveGroup, className: 'text-red-600 text-sm' }, 'Leave')
                            ),
                            e('div', { className: 'bg-indigo-50 border border-indigo-200 rounded-lg p-4' },
                                e('div', { className: 'flex justify-between items-center' },
                                    e('div', null,
                                        e('p', { className: 'text-sm text-indigo-700' }, 'Group ID'),
                                        e('p', { className: 'text-2xl font-mono font-bold text-indigo-900' }, groupId)
                                    ),
                                    e('button', { onClick: copyId, className: 'bg-indigo-600 text-white px-4 py-2 rounded-lg' }, 
                                        copied ? 'âœ“' : 'ðŸ“‹ Copy')
                                )
                            )
                        ),
                        e('div', { className: 'bg-white rounded-lg shadow-lg p-6 mb-6' },
                            e('div', { className: 'flex justify-between mb-4' },
                                e('h2', { className: 'text-xl font-semibold' }, `ðŸ‘¥ Friends (${friends.length})`),
                                e('button', { onClick: () => setShowAddFriend(!showAddFriend), className: 'bg-indigo-600 text-white px-4 py-2 rounded-lg' }, '+')
                            ),
                            showAddFriend && e('div', { className: 'mb-4 flex gap-2' },
                                e('input', { type: 'text', value: newFriendName, onChange: (ev) => setNewFriendName(ev.target.value),
                                    onKeyPress: (ev) => ev.key === 'Enter' && addFriend(), placeholder: "Name",
                                    className: 'flex-1 px-4 py-2 border rounded-lg' }),
                                e('button', { onClick: addFriend, className: 'bg-green-600 text-white px-4 py-2 rounded-lg' }, 'âœ“'),
                                e('button', { onClick: () => setShowAddFriend(false), className: 'bg-gray-400 text-white px-4 py-2 rounded-lg' }, 'âœ•')
                            ),
                            e('div', { className: 'space-y-2' },
                                friends.map(f => e('div', { key: f.id, className: 'flex justify-between bg-gray-50 p-3 rounded-lg' },
                                    e('div', null,
                                        e('div', { className: 'font-medium' }, f.name),
                                        e('div', { className: 'text-sm text-gray-600' }, 
                                            `$${Math.abs(balances[f.id] || 0).toFixed(2)} `,
                                            balances[f.id] > 0.01 ? '(gets back)' : balances[f.id] < -0.01 ? '(owes)' : '(settled)'
                                        )
                                    ),
                                    e('button', { onClick: () => removeFriend(f.id), className: 'text-red-500' }, 'âœ•')
                                ))
                            ),
                            friends.length === 0 && e('p', { className: 'text-gray-500 text-center py-8' }, 'Add friends to start!')
                        ),
                        friends.length > 0 && e('div', { className: 'bg-white rounded-lg shadow-lg p-6 mb-6' },
                            e('div', { className: 'flex justify-between mb-4' },
                                e('h2', { className: 'text-xl font-semibold' }, `ðŸ’¸ Expenses (${expenses.length})`),
                                e('button', { onClick: () => setShowAddExpense(!showAddExpense), className: 'bg-indigo-600 text-white px-4 py-2 rounded-lg' }, '+')
                            ),
                            showAddExpense && e('div', { className: 'mb-4 bg-gray-50 p-4 rounded-lg' },
                                e('input', { type: 'text', value: expenseDesc, onChange: (ev) => setExpenseDesc(ev.target.value),
                                    placeholder: 'Description', className: 'w-full px-4 py-2 border rounded-lg mb-2' }),
                                e('input', { type: 'number', step: '0.01', value: expenseAmount, onChange: (ev) => setExpenseAmount(ev.target.value),
                                    placeholder: 'Amount', className: 'w-full px-4 py-2 border rounded-lg mb-2' }),
                                e('select', { value: expensePayer, onChange: (ev) => setExpensePayer(ev.target.value), className: 'w-full px-4 py-2 border rounded-lg mb-2' },
                                    e('option', { value: '' }, 'Who paid?'),
                                    friends.map(f => e('option', { key: f.id, value: f.id }, f.name))
                                ),
                                e('div', { className: 'mb-2' },
                                    e('p', { className: 'text-sm mb-1' }, 'Split between:'),
                                    e('div', { className: 'grid grid-cols-2 gap-1' },
                                        friends.map(f => e('label', { key: f.id, className: 'flex items-center gap-1' },
                                            e('input', { type: 'checkbox', checked: expenseParticipants.has(f.id),
                                                onChange: () => toggleParticipant(f.id) }),
                                            e('span', { className: 'text-sm' }, f.name)
                                        ))
                                    )
                                ),
                                e('div', { className: 'flex gap-2' },
                                    e('button', { onClick: addExpense, className: 'flex-1 bg-green-600 text-white px-4 py-2 rounded-lg' }, 'Add'),
                                    e('button', { onClick: () => setShowAddExpense(false), className: 'bg-gray-400 text-white px-4 py-2 rounded-lg' }, 'Cancel')
                                )
                            ),
                            e('div', { className: 'space-y-2' },
                                expenses.slice().reverse().map(exp => e('div', { key: exp.id, className: 'bg-gray-50 p-3 rounded-lg' },
                                    e('div', { className: 'flex justify-between' },
                                        e('div', null,
                                            e('div', { className: 'font-semibold' }, exp.description),
                                            e('div', { className: 'text-sm text-gray-600' }, `${getFriendName(exp.payerId)} paid $${exp.amount.toFixed(2)}`),
                                            e('div', { className: 'text-xs text-gray-500' }, `$${(exp.amount / exp.participantIds.length).toFixed(2)}/person`)
                                        ),
                                        e('button', { onClick: () => removeExpense(exp.id), className: 'text-red-500' }, 'âœ•')
                                    )
                                ))
                            )
                        ),
                        friends.length > 0 && expenses.length > 0 && e('div', { className: 'bg-white rounded-lg shadow-lg p-6' },
                            e('div', { className: 'flex justify-between mb-4' },
                                e('h2', { className: 'text-xl font-semibold' }, 'Settle Up'),
                                e('button', { onClick: () => setShowSettlement(!showSettlement), className: 'bg-green-600 text-white px-4 py-2 rounded-lg' },
                                    showSettlement ? 'Hide' : 'Show')
                            ),
                            showSettlement && e('div', { className: 'bg-green-50 p-4 rounded-lg' },
                                settlements.length === 0 ? e('p', { className: 'text-green-700' }, 'All settled! ðŸŽ‰') :
                                e('div', { className: 'space-y-2' },
                                    settlements.map((s, i) => e('div', { key: i, className: 'bg-white p-3 rounded border-l-4 border-green-500' },
                                        e('p', null, `${getFriendName(s.from)} â†’ ${getFriendName(s.to)}`),
                                        e('p', { className: 'text-2xl font-bold text-green-600' }, `$${s.amount.toFixed(2)}`)
                                    ))
                                )
                            )
                        )
                    )
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(BillSplitter));
            console.log('âœ… App rendered');
        }
    </script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" 
            onload="window.scriptsLoaded.react=true; updateStatus('React loaded'); checkAllLoaded();"
            onerror="updateStatus('ERROR: React failed to load')"></script>
    
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" 
            onload="window.scriptsLoaded.reactDOM=true; updateStatus('ReactDOM loaded'); checkAllLoaded();"
            onerror="updateStatus('ERROR: ReactDOM failed to load')"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"
            onload="window.scriptsLoaded.firebase=true; updateStatus('Firebase app loaded'); checkAllLoaded();"
            onerror="updateStatus('ERROR: Firebase failed to load')"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"
            onload="updateStatus('Firebase database loaded');"
            onerror="updateStatus('ERROR: Firebase database failed to load')"></script>
</body>
</html>